const usuariosSistemas = [
    {user: "admin", pass: "admin2026", rol: "ADMIN"},
    {user: "torregranados", pass: "torre2026", rol: "OPERADOR"}
];

let usuarioActivo = null;

window.onload = () => {
    const savedUser = localStorage.getItem("rememberedUser");
    if(savedUser) {
        document.getElementById("loginUser").value = savedUser;
        document.getElementById("rememberMe").checked = true;
    }
};

let activos = JSON.parse(localStorage.getItem("activos")) || [];
activos = activos.map(v => ({...v, horaEntrada: new Date(v.horaEntrada), sellos: v.sellos || 0}));
let historial = JSON.parse(localStorage.getItem("historial")) || [];

setInterval(() => {
    const relojCont = document.getElementById('reloj');
    if(!relojCont) return;
    const ahora = new Date();
    relojCont.innerText = ahora.toLocaleTimeString();
    document.getElementById('fecha').innerText = ahora.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}, 1000);

function login(){
    let u = document.getElementById("loginUser").value;
    let p = document.getElementById("loginPass").value;
    let rem = document.getElementById("rememberMe").checked;
    let encontrado = usuariosSistemas.find(x => x.user === u && x.pass === p);
    if(!encontrado) return alert("Usuario o contrase침a incorrectos");
    if(rem) localStorage.setItem("rememberedUser", u);
    else localStorage.removeItem("rememberedUser");
    usuarioActivo = encontrado;
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("appCard").style.display = "block";
    document.getElementById("userDisplay").innerHTML = `游녻 ${usuarioActivo.rol}: ${usuarioActivo.user.toUpperCase()}`;
    actualizarLista();
}

function registrarEntrada(){
    let input = document.getElementById("plateInput");
    // Forzamos may칰sculas al guardar
    let placa = input.value.trim().toUpperCase();
    if(!placa) return;
    let v = {placa, horaEntrada: new Date(), user: usuarioActivo.user, sellos: 0};
    activos.push(v);
    localStorage.setItem("activos", JSON.stringify(activos));
    imprimirTicketEntrada(v);
    input.value = "";
    actualizarLista();
}

function cobrarTicketPerdido() {
    let placa = prompt("Ingrese la PLACA del veh칤culo:");
    if(!placa) return;
    let registro = {
        placa: placa.toUpperCase(),
        tipo: "TICKET PERDIDO",
        precio: 25,
        fecha: new Date().toLocaleDateString(),
        horaS: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
        operador: usuarioActivo.user
    };
    historial.push(registro);
    localStorage.setItem("historial", JSON.stringify(historial));
    alert("Ticket perdido registrado en historial (Q25)");
}

function cobrarBa침o() {
    historial.push({placa: "BA칌O", tipo: "BA칌O", precio: 3, fecha: new Date().toLocaleDateString(), operador: usuarioActivo.user});
    localStorage.setItem("historial", JSON.stringify(historial));
    alert("Ba침o registrado (Q3)");
}

function abrirModalMensual() { document.getElementById("modalMensual").style.display = "flex"; }
function cerrarModalMensual() { document.getElementById("modalMensual").style.display = "none"; }

function guardarMensualidad() {
    const nombre = document.getElementById("mNombre").value;
    const mes = document.getElementById("mMes").value;
    const costo = parseFloat(document.getElementById("mCosto").value);
    if(!nombre || !costo) return alert("Faltan datos");
    historial.push({placa: `MENSUAL: ${nombre.toUpperCase()} (${mes})`, tipo: "MENSUAL", precio: costo, fecha: new Date().toLocaleDateString(), operador: usuarioActivo.user});
    localStorage.setItem("historial", JSON.stringify(historial));
    cerrarModalMensual();
    alert("Mensualidad guardada");
}

function agregarSello(index){
    activos[index].sellos += 1;
    let v = activos[index];
    let min = Math.ceil((new Date() - v.horaEntrada) / 60000);
    if((v.sellos * 30) >= min) darSalida(index);
    else { localStorage.setItem("activos", JSON.stringify(activos)); actualizarLista(); }
}

function darSalida(index){
    let v = activos[index];
    let salida = new Date();
    let minTotales = Math.ceil((salida - v.horaEntrada) / 60000);
    let minFinales = Math.max(0, minTotales - (v.sellos * 30));
    let inicial = v.placa[0];
    let precio = 0;
    let valSelloTotal = Math.ceil(minTotales / 30) * (inicial === "M" ? 3 : 5);
    if(minFinales > 0) precio = Math.ceil(minFinales / 30) * (inicial === "M" ? 3 : 5);

    let registro = {
        placa: v.placa,
        tipo: (minFinales === 0 && v.sellos > 0) ? "SELLO TOTAL" : "EFECTIVO",
        horaE: v.horaEntrada.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
        horaS: salida.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
        fecha: salida.toLocaleDateString(),
        sellos: v.sellos,
        valorSello: (v.sellos > 0) ? valSelloTotal - precio : 0,
        precio: precio,
        operador: usuarioActivo.user
    };

    historial.push(registro);
    imprimirTicketSalida(registro);
    activos.splice(index, 1);
    localStorage.setItem("activos", JSON.stringify(activos));
    localStorage.setItem("historial", JSON.stringify(historial));
    actualizarLista();
}

function actualizarLista(){
    let cont = document.getElementById("activeList");
    cont.innerHTML = "";
    activos.forEach((v, i) => {
        let li = document.createElement("li"); li.className = "vehiculo-item";
        li.innerHTML = `<div class="placa-badge">${v.placa}</div><div class="action-btns">
            <button class="btn-sello" onclick="agregarSello(${i})">SELLO (${v.sellos})</button>
            <button class="btn-salida-list" onclick="darSalida(${i})">SALIDA</button></div>`;
        cont.appendChild(li);
    });
}

function toggleHistorial(){
    let box = document.getElementById("historialBox");
    if(box.style.display === "none") {
        box.style.display = "block";
        let html = historial.slice().reverse().map(h => `<div style="padding:8px; border-bottom:1px solid #eee; font-size:11px;"><b>${h.placa}</b> | Q${h.precio} | ${h.tipo || 'EFECTIVO'}</div>`).join('');
        if(usuarioActivo.rol === "ADMIN") html += `<button class="ios-btn-danger" onclick="borrarHistorialDefinitivo()">BORRAR PERMANENTE</button>`;
        else html += `<button class="ios-btn-danger" style="background:#ff9500" onclick="borrarTurno()">BORRAR TURNO</button>`;
        box.innerHTML = html || "Vac칤o";
    } else box.style.display = "none";
}

function borrarTurno(){ if(confirm("쮺errar turno?")){ historial = []; localStorage.setItem("historial", JSON.stringify(historial)); toggleHistorial(); } }
function borrarHistorialDefinitivo(){ if(confirm("쮹ORRAR TODO?")){ historial = []; localStorage.setItem("historial", JSON.stringify(historial)); toggleHistorial(); } }

function imprimirTicketEntrada(v){
    let w = window.open("","","width=300,height=500");
    w.document.write(`<html><body onload="window.print();window.close()"><center style="font-family:sans-serif; padding:10px; width:220px; border:1px solid #000;">
        <img src="logotorre.png" width="120"><br><hr>
        <p style="margin:5px 0; font-size:12px;">TICKET DE ENTRADA</p>
        <h1 style="font-size:45px; margin:5px 0;">${v.placa}</h1>
        <p style="font-size:12px;">FECHA: ${new Date().toLocaleDateString()}<br>HORA: ${new Date().toLocaleTimeString()}</p><hr>
        <p style="font-size:10px; font-weight:bold;">30 MINUTOS GRATIS EN SELLO<br>SE COBRAR츼 Q25 POR TICKET PERDIDO</p>
        <p style="font-size:9px;">No olvide dejar bien cerrado su veh칤culo o motocicleta.</p>
    </center></body></html>`);
    w.document.close();
}

function imprimirTicketSalida(h){
    let w = window.open("","","width=300,height=500");
    let pTxt = h.precio > 0 ? `Q${h.precio}.00` : `Q0.00 <br><small style="font-size:10px;">(Cubierto por Sello)</small>`;
    w.document.write(`<html><body onload="window.print();window.close()"><center style="font-family:sans-serif; padding:10px; width:220px; border:1px solid #000;">
        <img src="logotorre.png" width="120"><br><hr>
        <p style="margin:5px 0; font-size:12px;">TICKET DE SALIDA</p>
        <h1 style="font-size:40px; margin:5px 0;">${h.placa}</h1>
        <div style="background:#000; color:#fff; padding:10px; margin:10px 0;"><h1 style="margin:0; font-size:30px;">${pTxt}</h1></div>
        <p style="font-size:11px;">E: ${h.horaE || '--'} | S: ${h.horaS || '--'}</p><hr>
        <p style="font-size:10px;">춰Gracias por su visita!</p>
    </center></body></html>`);
    w.document.close();
}

function generarReporteHTML(){
    let trabajador = prompt("Nombre del trabajador:");
    if(!trabajador) return;
    
    let vehiculos = historial.filter(x => x.tipo === "EFECTIVO" || x.tipo === "SELLO TOTAL");
    let banos = historial.filter(x => x.tipo === "BA칌O");
    let mensuales = historial.filter(x => x.tipo === "MENSUAL");
    let perdidos = historial.filter(x => x.tipo === "TICKET PERDIDO");
    let totalCaja = historial.reduce((s,x)=>s+x.precio,0);
    let totalSellos = historial.reduce((s,x)=>s+(x.valorSello || 0),0);

    let v = window.open("", "_blank");
    v.document.write(`<html><body style="font-family:sans-serif; padding:20px; color:#333;">
        <div style="max-width:500px; margin:auto; border:1px solid #ccc; padding:20px; border-radius:10px;">
            <center><img src="logotorre.png" width="140">
            <h2 style="margin:10px 0;">REPORTE DE TURNO</h2>
            <p style="font-size:14px;"><b>Operador:</b> ${trabajador.toUpperCase()} | <b>Fecha:</b> ${new Date().toLocaleDateString()}</p></center>
            <hr>
            <h4 style="margin-bottom:5px;">VEH칈CULOS</h4>
            <table style="width:100%; font-size:12px; border-collapse:collapse; margin-bottom:10px;">
                <tr style="background:#f2f2f2; text-align:left;"><th style="padding:5px;">Placa</th><th>Tipo</th><th>Monto</th></tr>
                ${vehiculos.map(x=>`<tr><td style="padding:4px; border-bottom:1px solid #eee;">${x.placa}</td><td style="border-bottom:1px solid #eee;">${x.tipo}</td><td style="border-bottom:1px solid #eee;">Q${x.precio}</td></tr>`).join('')}
            </table>
            <h4 style="margin-bottom:5px;">SERVICIOS Y OTROS</h4>
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                ${banos.map(x=>`<tr><td style="padding:4px; border-bottom:1px solid #eee;">Uso de Ba침o</td><td style="text-align:right; border-bottom:1px solid #eee;">Q${x.precio}</td></tr>`).join('')}
                ${mensuales.map(x=>`<tr><td style="padding:4px; border-bottom:1px solid #eee;">${x.placa}</td><td style="text-align:right; border-bottom:1px solid #eee;">Q${x.precio}</td></tr>`).join('')}
                ${perdidos.map(x=>`<tr><td style="padding:4px; border-bottom:1px solid #eee;">T. Perdido: ${x.placa}</td><td style="text-align:right; border-bottom:1px solid #eee;">Q${x.precio}</td></tr>`).join('')}
            </table>
            <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-top:20px;">
                <table style="width:100%;">
                    <tr><td><b>TOTAL EN CAJA:</b></td><td style="text-align:right;"><b>Q${totalCaja}.00</b></td></tr>
                    <tr style="color:#666; font-size:13px;"><td>Pendiente Sellos:</td><td style="text-align:right;">Q${totalSellos}.00</td></tr>
                </table>
            </div>
        </div>
    </body></html>`);
    v.document.close();
    v.print();
}
